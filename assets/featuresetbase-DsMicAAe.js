import{m as Fe}from"./TimeOnly-tMUNIzIb.js";import{t as b,F as De,G as X,K as A,N as C,a as c,r as m,P as v,d as E,J as Te,Q as de,S as ue,W as ce,Y as L,T as k,E as N,U as G,V as xe,X as $,Z as be,v as Ee,h as O,D as Ne,_ as Ae,$ as _,a0 as Y,a1 as Se,a2 as q}from"./arcadeUtils-F9sEFE1E.js";import{M as Le,q as me,f as Ze,c as B,e as Ce,a as ve,b as Pe,T as ee,E as Re,N as Ue,O as Me,L as M,B as $e,d as K,R as Z,k as te}from"./featureSetUtils-C-KG7fcx.js";import{l as ke}from"./portalUtils-BhucQa2w.js";import{u as Oe,O as pe}from"./SpatialFilter-DsDWrTS4.js";import{b as ye,S as ze}from"./index-DMwY2Yeh.js";import{Z as x}from"./WhereClause-BPNiQ3zv.js";import ne from"./FeatureLayer-DJWXNlK7.js";import{y as j}from"./Field-FlLvuz43.js";import"./FieldsIndex-Bpsh9sfE.js";import"./number-DMASjCPY.js";import"./Query-Dd46G94Q.js";import"./TimeExtent-D_QVyVxF.js";import"./featureConversionUtils-XDJcSzWE.js";import"./OptimizedFeature-D3320lj0.js";import"./OptimizedFeatureSet-Blu9Ckm7.js";import"./uuid-Cl5lrJ4c.js";import"./MD5-C9MwAd2G.js";import"./labelUtils-C913L2yL.js";import"./labelingInfo-DW8snHub.js";import"./layerUtils-Co4QOtAn.js";import"./jsonUtils-h7tU0Uer.js";import"./UniqueValueRenderer-BWeIsITM.js";import"./RendererLegendOptions-wLw-yCIt.js";import"./diffUtils-BNvOWYG7.js";import"./enums-BoehirYs.js";import"./colorRamps-D2x6Yad2.js";import"./compilerUtils-RCjhmI8-.js";import"./lengthUtils-DPy0fDMV.js";import"./styleUtils-BSN3jcA_.js";import"./defaults-BtwZGStO.js";import"./defaultsJSON-GKolV7NZ.js";import"./LRUCache-BZgFsCAB.js";import"./Version-DMGHCpYW.js";import"./colorUtils-BPNTvscP.js";import"./vec42-CwZz9wN3.js";import"./common-DokbeE9L.js";import"./vec4f64-CMoMXWBi.js";import"./heatmapUtils-BzMZhmln.js";import"./FeatureType-6tQpydB5.js";import"./FeatureTemplate-BlCBJqjQ.js";import"./Layer-B7MPCWr8.js";import"./PortalItem-CJdFYfTh.js";import"./geometryEngineAsync-DPJ5PHBH.js";import"./workers-CugKOIjN.js";import"./commonProperties-BfyFIYkl.js";import"./ElevationInfo-BPUkZdoe.js";import"./FeatureLayerBase-ByqPE2AP.js";import"./HeightModelInfo-rMgJ0rVv.js";import"./arcgisLayerUrl-C2XR9Yu_.js";import"./LayerFloorInfo-5CyudU4-.js";import"./Relationship-C-GsegB8.js";import"./serviceCapabilitiesUtils-BX5R9Pi1.js";import"./editsZScale-DanZRiM6.js";import"./queryZScale-C4tBtOnP.js";import"./zscale-DcxcvFoT.js";import"./FeatureSet-1CBcRwmx.js";import"./APIKeyMixin-CNoRPVWe.js";import"./ArcGISService-DfIkeWvW.js";import"./BlendLayer-BZi4HZ3X.js";import"./mat4f32-DcsiF_Rp.js";import"./mat4-DsYZliz4.js";import"./CustomParametersMixin-D4WPrEFl.js";import"./EditBusLayer-ChZHps1o.js";import"./FeatureEffectLayer-DJvLedEL.js";import"./FeatureReductionLayer-BJl1hgu6.js";import"./FeatureReductionSelection-D7R64uU4.js";import"./OperationalLayer-DkH5aW2U.js";import"./OrderedLayer-C_Azou6p.js";import"./PortalLayer-DdSdd8Dt.js";import"./portalItemUtils-Doqe9RdJ.js";import"./projection-DL1aNLQS.js";import"./projectBuffer-CWX1J5rk.js";import"./RefreshableLayer-KOp797qb.js";import"./ScaleRangeLayer-BawLb3lW.js";import"./TemporalLayer-DyyQYNf6.js";import"./TimeInfo-Bc08AgQt.js";import"./fieldProperties-ToAvmRQ-.js";import"./versionUtils-BHPRD1Gp.js";import"./styleUtils-CesrUL8M.js";import"./popupUtils-DpbfCD_q.js";import"./AlphaCutoff-UcccL64p.js";import"./interfaces-CL2NbQte.js";import"./fieldType-C6h0mWzJ.js";function We(i){if(i.length===1){if(N(i[0]))return q("distinct",i[0],-1);if($(i[0]))return q("distinct",i[0].toArray(),-1)}return q("distinct",i,-1)}async function ie(i,t,a){const y=i.getVariables();if(y.length>0){const F=[];for(let n=0;n<y.length;n++){const s={name:y[n]};F.push(await t.evaluateIdentifier(a,s))}const e={};for(let n=0;n<y.length;n++)e[y[n]]=F[n];return i.parameters=e,i}return i}function u(i,t,a=null){for(const y in i)if(y.toLowerCase()===t.toLowerCase())return i[y];return a}function we(i){if(i===null)return null;const t={type:u(i,"type",""),name:u(i,"name","")};if(t.type==="range")t.range=u(i,"range",[]);else{t.codedValues=[];for(const a of u(i,"codedValues",[]))t.codedValues.push({name:u(a,"name",""),code:u(a,"code",null)})}return t}function ae(i){if(i===null)return null;const t={},a=u(i,"wkt");a!==null&&(t.wkt=a);const y=u(i,"wkid");return y!==null&&(t.wkid=y),t}function he(i){if(i===null)return null;const t={hasZ:u(i,"hasz",!1),hasM:u(i,"hasm",!1)},a=u(i,"spatialreference");a!=null&&(t.spatialReference=ae(a));const y=u(i,"x",null);if(y!==null)return t.x=y,t.y=u(i,"y",null),t.hasZ&&(t.z=u(i,"z",null)),t.hasM&&(t.m=u(i,"m",null)),t;const F=u(i,"rings",null);if(F!==null)return t.rings=F,t;const e=u(i,"paths",null);if(e!==null)return t.paths=e,t;const n=u(i,"points",null);if(n!==null)return t.points=n,t;for(const s of["xmin","xmax","ymin","ymax","zmin","zmax","mmin","mmax"]){const f=u(i,s,null);f!==null&&(t[s]=f)}return t}function He(i,t){for(const a of t)if(a===i)return!0;return!1}function je(i){return!!i.layerDefinition&&!!i.featureSet&&He(i.layerDefinition.geometryType,["",null,"esriGeometryNull","esriGeometryPoint","esriGeometryPolyline","esriGeometryPolygon","esriGeometryMultipoint","esriGeometryEnvelope"])!==!1&&N(i.layerDefinition.fields)!==!1&&N(i.featureSet.features)!==!1}function z(i){return(i==null?void 0:i.toLowerCase())==="utc"?"UTC":(i==null?void 0:i.toLowerCase())==="unknown"?"Unknown":i}function Dn(i){i.mode==="async"&&(i.functions.timezone=function(t,a){return i.standardFunctionAsync(t,a,async(y,F,e)=>{var f,p;if(b(e,1,2,t,a),De(e[0])||X(e[0]))return"Unknown";if(A(e[0])){if(await e[0].load(),e.length===1||e[1]===null)return e[0].datesInUnknownTimezone?z("unknown"):z(e[0].dateFieldsTimeZone);if(!(e[1]instanceof C)||e[1].hasField("type")===!1)throw new c(t,m.InvalidParameter,a);const l=e[1].field("type");if(v(l)===!1)throw new c(t,m.InvalidParameter,a);switch(E(l).toLowerCase()){case"preferredtimezone":return z(e[0].preferredTimeZone);case"editfieldsinfo":return z(((f=e[0].editFieldsInfo)==null?void 0:f.timeZone)??null);case"timeinfo":return z(((p=e[0].timeInfo)==null?void 0:p.timeZone)??null);case"field":if(e[1].hasField("fieldname")&&v(e[1].field("fieldname")))return z(e[0].fieldTimeZone(E(e[1].field("fieldname"))))}throw new c(t,m.InvalidParameter,a)}const n=Te(e[0],de(t));if(n===null)return null;const s=n.timeZone;return s==="system"?Fe.systemTimeZoneCanonicalName:s.toLowerCase()==="utc"?"UTC":s.toLowerCase()==="unknown"?"Unknown":s})},i.functions.sqltimestamp=function(t,a){return i.standardFunctionAsync(t,a,async(y,F,e)=>{b(e,1,3,t,a);const n=e[0];if(ue(n)){if(e.length===1)return n.toSQLWithKeyword();if(e.length===2)return n.changeTimeZone(E(e[1])).toSQLWithKeyword();throw new c(t,m.InvalidParameter,a)}if(X(n))return n.toSQLWithKeyword();if(A(n)){if(e.length!==3)throw new c(t,m.InvalidParameter,a);await n.load();const s=E(e[1]);if(X(e[2]))return e[2].toSQLWithKeyword();if(ue(e[2])===!1)throw new c(t,m.InvalidParameter,a);const f=n.fieldTimeZone(s);return f===null?e[2].toSQLWithKeyword():e[2].changeTimeZone(f).toSQLWithKeyword()}throw new c(t,m.InvalidParameter,a)})},i.signatures.push({name:"sqltimestamp",min:2,max:4}),i.functions.featuresetbyid=function(t,a){return i.standardFunctionAsync(t,a,(y,F,e)=>{if(b(e,2,4,t,a),ce(e[0])){const n=E(e[1]);let s=L(e[2],null);const f=k(L(e[3],!0));if(s===null&&(s=["*"]),N(s)===!1)throw new c(t,m.InvalidParameter,a);return e[0].featureSetById(n,f,s)}throw new c(t,m.InvalidParameter,a)})},i.signatures.push({name:"featuresetbyid",min:2,max:4}),i.functions.getfeatureset=function(t,a){return i.standardFunctionAsync(t,a,async(y,F,e)=>{if(b(e,1,2,t,a),G(e[0])){let n=L(e[1],"datasource");return n===null&&(n="datasource"),n=E(n).toLowerCase(),Le(e[0].fullSchema(),n,t.lrucache,t.interceptor,t.spatialReference??null)}throw new c(t,m.InvalidParameter,a)})},i.signatures.push({name:"getfeatureset",min:1,max:2}),i.functions.featuresetbyportalitem=function(t,a){return i.standardFunctionAsync(t,a,(y,F,e)=>{var l,r;if(b(e,2,5,t,a),e[0]===null)throw new c(t,m.PortalRequired,a);if(e[0]instanceof xe){const o=E(e[1]),d=E(e[2]);let w=L(e[3],null);const D=k(L(e[4],!0));if(w===null&&(w=["*"]),N(w)===!1)throw new c(t,m.InvalidParameter,a);let h;return h=(l=t.services)!=null&&l.portal?t.services.portal:ye.getDefault(),h=ke(e[0],h),me(o,d,t.spatialReference??null,w,D,h,t.lrucache,t.interceptor)}if(v(e[0])===!1)throw new c(t,m.PortalRequired,a);const n=E(e[0]),s=E(e[1]);let f=L(e[2],null);const p=k(L(e[3],!0));if(f===null&&(f=["*"]),N(f)===!1)throw new c(t,m.InvalidParameter,a);return me(n,s,t.spatialReference??null,f,p,((r=t.services)==null?void 0:r.portal)??ye.getDefault(),t.lrucache,t.interceptor)})},i.signatures.push({name:"featuresetbyportalitem",min:2,max:5}),i.functions.featuresetbyname=function(t,a){return i.standardFunctionAsync(t,a,(y,F,e)=>{if(b(e,2,4,t,a),ce(e[0])){const n=E(e[1]);let s=L(e[2],null);const f=k(L(e[3],!0));if(s===null&&(s=["*"]),N(s)===!1)throw new c(t,m.InvalidParameter,a);return e[0].featureSetByName(n,f,s)}throw new c(t,m.InvalidParameter,a)})},i.signatures.push({name:"featuresetbyname",min:2,max:4}),i.functions.featureset=function(t,a){return i.standardFunction(t,a,(y,F,e)=>{b(e,1,1,t,a);const n={layerDefinition:{geometryType:"",objectIdField:"",globalIdField:"",typeIdField:"",hasM:!1,hasZ:!1,fields:[]},featureSet:{geometryType:"",features:[]}};if(v(e[0])){const s=JSON.parse(e[0]);s.layerDefinition!==void 0?(n.layerDefinition=s.layerDefinition,n.featureSet=s.featureSet,s.layerDefinition.spatialReference&&(n.layerDefinition.spatialReference=s.layerDefinition.spatialReference)):(n.featureSet.features=s.features,n.featureSet.geometryType=s.geometryType,n.layerDefinition.geometryType=n.featureSet.geometryType,n.layerDefinition.objectIdField=s.objectIdFieldName??"",n.layerDefinition.typeIdField=s.typeIdFieldName,n.layerDefinition.globalIdField=s.globalIdFieldName,n.layerDefinition.fields=s.fields,s.spatialReference&&(n.layerDefinition.spatialReference=s.spatialReference))}else{if(!(e[0]instanceof C))throw new c(t,m.InvalidParameter,a);{const s=JSON.parse(e[0].castToText(!0)),f=u(s,"layerdefinition");if(f!==null){n.layerDefinition.geometryType=u(f,"geometrytype",""),n.featureSet.geometryType=n.layerDefinition.geometryType,n.layerDefinition.globalIdField=u(f,"globalidfield",""),n.layerDefinition.objectIdField=u(f,"objectidfield",""),n.layerDefinition.typeIdField=u(f,"typeidfield",""),n.layerDefinition.hasZ=u(f,"hasz",!1)===!0,n.layerDefinition.hasM=u(f,"hasm",!1)===!0;const p=u(f,"spatialreference");p&&(n.layerDefinition.spatialReference=ae(p));const l=[];for(const o of u(f,"fields",[])){const d={name:u(o,"name",""),alias:u(o,"alias",""),type:u(o,"type",""),nullable:u(o,"nullable",!0),editable:u(o,"editable",!0),length:u(o,"length",null),domain:we(u(o,"domain"))};l.push(d)}n.layerDefinition.fields=l;const r=u(s,"featureset");if(r){const o={};for(const d of l)o[d.name.toLowerCase()]=d.name;for(const d of u(r,"features",[])){const w={},D=u(d,"attributes",{});for(const h in D)w[o[h.toLowerCase()]]=D[h];n.featureSet.features.push({attributes:w,geometry:he(u(d,"geometry"))})}}}else{n.layerDefinition.hasZ=u(s,"hasz",!1)===!0,n.layerDefinition.hasM=u(s,"hasm",!1)===!0,n.layerDefinition.geometryType=u(s,"geometrytype",""),n.featureSet.geometryType=n.layerDefinition.geometryType,n.layerDefinition.objectIdField=u(s,"objectidfieldname",""),n.layerDefinition.typeIdField=u(s,"typeidfieldname","");const p=u(s,"spatialreference");p&&(n.layerDefinition.spatialReference=ae(p));const l=[],r=u(s,"fields",null);if(!N(r))throw new c(t,m.InvalidParameter,a);for(const w of r){const D={name:u(w,"name",""),alias:u(w,"alias",""),type:u(w,"type",""),nullable:u(w,"nullable",!0),editable:u(w,"editable",!0),length:u(w,"length",null),domain:we(u(w,"domain"))};l.push(D)}n.layerDefinition.fields=l;const o={};for(const w of l)o[w.name.toLowerCase()]=w.name;let d=u(s,"features",null);if(N(d))for(const w of d){const D={},h=u(w,"attributes",{});for(const T in h)D[o[T.toLowerCase()]]=h[T];n.featureSet.features.push({attributes:D,geometry:he(u(w,"geometry",null))})}else d=null,n.featureSet.features=d}}}if(je(n)===!1)throw new c(t,m.InvalidParameter,a);return n.layerDefinition.geometryType||(n.layerDefinition.geometryType="esriGeometryNull"),Ze.create(n,t.spatialReference)})},i.signatures.push({name:"featureset",min:1,max:1}),i.functions.filter=function(t,a){return i.standardFunctionAsync(t,a,async(y,F,e)=>{if(b(e,2,2,t,a),N(e[0])||$(e[0])){const n=[];let s,f=e[0];if(f instanceof be&&(f=f.toArray()),!Ee(e[1]))throw new c(t,m.InvalidParameter,a);s=e[1].createFunction(t);for(const p of f){const l=s(p);ze(l)?await l===!0&&n.push(p):l===!0&&n.push(p)}return n}if(A(e[0])){const n=await e[0].load(),s=x.create(e[1],{fieldsIndex:n.getFieldsIndex(),timeZone:n.dateFieldsTimeZoneDefaultUTC}),f=s.getVariables();if(f.length>0){const p=[];for(let r=0;r<f.length;r++){const o={name:f[r]};p.push(await i.evaluateIdentifier(t,o))}const l={};for(let r=0;r<f.length;r++)l[f[r]]=p[r];return s.parameters=l,new B({parentfeatureset:e[0],whereclause:s})}return new B({parentfeatureset:e[0],whereclause:s})}throw new c(t,m.InvalidParameter,a)})},i.signatures.push({name:"filter",min:2,max:2}),i.functions.orderby=function(t,a){return i.standardFunctionAsync(t,a,async(y,F,e)=>{if(b(e,2,2,t,a),A(e[0])){const n=new Ce(e[1]);return new ve({parentfeatureset:e[0],orderbyclause:n})}throw new c(t,m.InvalidParameter,a)})},i.signatures.push({name:"orderby",min:2,max:2}),i.functions.top=function(t,a){return i.standardFunctionAsync(t,a,async(y,F,e)=>{if(b(e,2,2,t,a),A(e[0]))return new Pe({parentfeatureset:e[0],topnum:e[1]});if(N(e[0]))return O(e[1])>=e[0].length?e[0].slice():e[0].slice(0,O(e[1]));if($(e[0]))return O(e[1])>=e[0].length()?e[0].slice():e[0].slice(0,O(e[1]));throw new c(t,m.InvalidParameter,a)})},i.signatures.push({name:"top",min:2,max:2}),i.functions.first=function(t,a){return i.standardFunctionAsync(t,a,async(y,F,e)=>{if(b(e,1,1,t,a),A(e[0])){const n=await e[0].first(y.abortSignal);if(n!==null){const s=Ne.createFromGraphicLikeObject(n.geometry,n.attributes,e[0],t.timeZone);return s._underlyingGraphic=n,s}return n}return N(e[0])?e[0].length===0?null:e[0][0]:$(e[0])?e[0].length()===0?null:e[0].get(0):null})},i.signatures.push({name:"first",min:1,max:1}),i.functions.attachments=function(t,a){return i.standardFunctionAsync(t,a,async(y,F,e)=>{b(e,1,2,t,a);const n={minsize:-1,maxsize:-1,types:null,returnMetadata:!1};if(e.length>1){if(e[1]instanceof C){if(e[1].hasField("minsize")&&(n.minsize=O(e[1].field("minsize"))),e[1].hasField("metadata")&&(n.returnMetadata=k(e[1].field("metadata"))),e[1].hasField("maxsize")&&(n.maxsize=O(e[1].field("maxsize"))),e[1].hasField("types")){const s=Ae(e[1].field("types"),!1);s.length>0&&(n.types=s)}}else if(e[1]!==null)throw new c(t,m.InvalidParameter,a)}if(G(e[0])){let s=e[0]._layer;return s instanceof ne&&(s=ee(s,t.spatialReference,["*"],!0,t.lrucache,t.interceptor)),s===null?[]:A(s)===!1?[]:(await s.load(),s.queryAttachments(e[0].field(s.objectIdField),n.minsize,n.maxsize,n.types,n.returnMetadata))}if(e[0]===null)return[];throw new c(t,m.InvalidParameter,a)})},i.signatures.push({name:"attachments",min:1,max:2}),i.functions.featuresetbyrelationshipname=function(t,a){return i.standardFunctionAsync(t,a,async(y,F,e)=>{b(e,2,4,t,a);const n=e[0],s=E(e[1]);let f=L(e[2],null);const p=k(L(e[3],!0));if(f===null&&(f=["*"]),N(f)===!1)throw new c(t,m.InvalidParameter,a);if(e[0]===null)return null;if(!G(e[0]))throw new c(t,m.InvalidParameter,a);let l=n._layer;if(l instanceof ne&&(l=ee(l,t.spatialReference,["*"],!0,t.lrucache,t.interceptor)),l===null||A(l)===!1)return null;l=await l.load();const r=l.relationshipMetaData().filter(h=>h.name===s);if(r.length===0)return null;if(r[0].relationshipTableId!==void 0&&r[0].relationshipTableId!==null&&r[0].relationshipTableId>-1)return Re(l,r[0],n.field(l.objectIdField),l.spatialReference,f,p,t.lrucache,t.interceptor);let o=l.serviceUrl();if(!o)return null;o=o.charAt(o.length-1)==="/"?o+r[0].relatedTableId.toString():o+"/"+r[0].relatedTableId.toString();const d=await Ue(o,l.spatialReference,f,p,t.lrucache,t.interceptor);await d.load();let w=d.relationshipMetaData();if(w=w.filter(h=>h.id===r[0].id),n.hasField(r[0].keyField)===!1||n.field(r[0].keyField)===null){const h=await l.getFeatureByObjectId(n.field(l.objectIdField),[r[0].keyField]);if(h){const T=x.create(w[0].keyField+"= @id",{fieldsIndex:d.getFieldsIndex(),timeZone:d.dateFieldsTimeZoneDefaultUTC});return T.parameters={id:h.attributes[r[0].keyField]},d.filter(T)}return new Oe({parentfeatureset:d})}const D=x.create(w[0].keyField+"= @id",{fieldsIndex:d.getFieldsIndex(),timeZone:d.dateFieldsTimeZoneDefaultUTC});return D.parameters={id:n.field(r[0].keyField)},d.filter(D)})},i.signatures.push({name:"featuresetbyrelationshipname",min:2,max:4}),i.functions.featuresetbyassociation=function(t,a){return i.standardFunctionAsync(t,a,async(y,F,e)=>{b(e,2,3,t,a);const n=e[0],s=E(L(e[1],"")).toLowerCase(),f=v(e[2])?E(e[2]):null;if(e[0]===null)return null;if(!G(e[0]))throw new c(t,m.InvalidParameter,a);let p=n._layer;if(p instanceof ne&&(p=ee(p,t.spatialReference,["*"],!0,t.lrucache,t.interceptor)),p===null||A(p)===!1)return null;await p.load();const l=p.serviceUrl(),r=await Me(l,t.spatialReference);let o=null,d=null,w=!1;if(f!==null&&f!==""&&f!==void 0){for(const g of r.terminals)g.terminalName===f&&(d=g.terminalId);d===null&&(w=!0)}const D=r.associations.getFieldsIndex(),h=D.get("TOGLOBALID").name,T=D.get("FROMGLOBALID").name,V=D.get("TOTERMINALID").name,Q=D.get("FROMTERMINALID").name,W=D.get("FROMNETWORKSOURCEID").name,H=D.get("TONETWORKSOURCEID").name,U=D.get("ASSOCIATIONTYPE").name,Ie=D.get("ISCONTENTVISIBLE").name,ge=D.get("OBJECTID").name;for(const g of p.fields)if(g.type==="global-id"){o=n.field(g.name);break}let P=null,re=new M(new j({name:"percentalong",alias:"percentalong",type:"double"}),x.create("0",{fieldsIndex:r.associations.getFieldsIndex(),timeZone:r.associations.dateFieldsTimeZoneDefaultUTC})),se=new M(new j({name:"side",alias:"side",type:"string"}),x.create("''",{fieldsIndex:r.associations.getFieldsIndex(),timeZone:r.associations.dateFieldsTimeZoneDefaultUTC}));const S="globalid",oe="globalId",le={};for(const g in r.lkp)le[g]=r.lkp[g].sourceId;const R=new $e(new j({name:"classname",alias:"classname",type:"string"}),null,le);let I="";switch(s){case"midspan":{I=`((${h}='${o}') OR ( ${T}='${o}')) AND (${U} IN (5))`,R.codefield=x.create(`CASE WHEN (${h}='${o}') THEN ${W} ELSE ${H} END`,{fieldsIndex:r.associations.getFieldsIndex(),timeZone:r.associations.dateFieldsTimeZoneDefaultUTC});const g=Y(Z.findField(r.associations.fields,T));g.name=S,g.alias=S,P=new M(g,x.create(`CASE WHEN (${T}='${o}') THEN ${h} ELSE ${T} END`,{fieldsIndex:r.associations.getFieldsIndex(),timeZone:r.associations.dateFieldsTimeZoneDefaultUTC})),re=r.unVersion>=4?new te(Z.findField(r.associations.fields,D.get("PERCENTALONG").name)):new M(new j({name:"percentalong",alias:"percentalong",type:"double"}),x.create("0",{fieldsIndex:r.associations.getFieldsIndex(),timeZone:r.associations.dateFieldsTimeZoneDefaultUTC}));break}case"junctionedge":{I=`((${h}='${o}') OR ( ${T}='${o}')) AND (${U} IN (4,6))`,R.codefield=x.create(`CASE WHEN (${h}='${o}') THEN ${W} ELSE ${H} END`,{fieldsIndex:r.associations.getFieldsIndex(),timeZone:r.associations.dateFieldsTimeZoneDefaultUTC});const g=Y(Z.findField(r.associations.fields,T));g.name=S,g.alias=S,P=new M(g,x.create(`CASE WHEN (${T}='${o}') THEN ${h} ELSE ${T} END`,{fieldsIndex:r.associations.getFieldsIndex(),timeZone:r.associations.dateFieldsTimeZoneDefaultUTC})),se=new M(new j({name:"side",alias:"side",type:"string"}),x.create(`CASE WHEN (${U}=4) THEN 'from' ELSE 'to' END`,{fieldsIndex:r.associations.getFieldsIndex(),timeZone:r.associations.dateFieldsTimeZoneDefaultUTC}));break}case"connected":{let g=`${h}='@T'`,fe=`${T}='@T'`;d!==null&&(g+=` AND ${V}=@A`,fe+=` AND ${Q}=@A`),I="(("+g+") OR ("+fe+"))",I=_(I,"@T",o??""),g=_(g,"@T",o??""),d!==null&&(g=_(g,"@A",d.toString()),I=_(I,"@A",d.toString())),R.codefield=x.create("CASE WHEN "+g+` THEN ${W} ELSE ${H} END`,{fieldsIndex:r.associations.getFieldsIndex(),timeZone:r.associations.dateFieldsTimeZoneDefaultUTC});const J=Y(Z.findField(r.associations.fields,T));J.name=S,J.alias=S,P=new M(J,x.create("CASE WHEN "+g+` THEN ${T} ELSE ${h} END`,{fieldsIndex:r.associations.getFieldsIndex(),timeZone:r.associations.dateFieldsTimeZoneDefaultUTC}));break}case"container":I=`${h}='${o}' AND ${U} = 2`,d!==null&&(I+=` AND ${V} = `+d.toString()),R.codefield=W,I="( "+I+" )",P=new K(Z.findField(r.associations.fields,T),S,S);break;case"content":I=`(${T}='${o}' AND ${U} = 2)`,d!==null&&(I+=` AND ${Q} = `+d.toString()),R.codefield=H,I="( "+I+" )",P=new K(Z.findField(r.associations.fields,h),S,S);break;case"structure":I=`(${h}='${o}' AND ${U} = 3)`,d!==null&&(I+=` AND ${V} = `+d.toString()),R.codefield=W,I="( "+I+" )",P=new K(Z.findField(r.associations.fields,T),S,oe);break;case"attached":I=`(${T}='${o}' AND ${U} = 3)`,d!==null&&(I+=` AND ${Q} = `+d.toString()),R.codefield=H,I="( "+I+" )",P=new K(Z.findField(r.associations.fields,h),S,oe);break;default:throw new c(t,m.InvalidParameter,a)}return w&&(I="1 <> 1"),new Z({parentfeatureset:r.associations,adaptedFields:[new te(Z.findField(r.associations.fields,ge)),new te(Z.findField(r.associations.fields,Ie)),P,se,R,re],extraFilter:I?x.create(I,{fieldsIndex:r.associations.getFieldsIndex(),timeZone:r.associations.dateFieldsTimeZoneDefaultUTC}):null})})},i.signatures.push({name:"featuresetbyassociation",min:2,max:6}),i.functions.groupby=function(t,a){return i.standardFunctionAsync(t,a,async(y,F,e)=>{if(b(e,3,3,t,a),!A(e[0]))throw new c(t,m.InvalidParameter,a);const n=await e[0].load(),s=[],f=[];let p=!1,l=[];if(v(e[1]))l.push(e[1]);else if(e[1]instanceof C)l.push(e[1]);else if(N(e[1]))l=e[1];else{if(!$(e[1]))throw new c(t,m.InvalidParameter,a);l=e[1].toArray()}for(const r of l)if(v(r)){const o=x.create(E(r),{fieldsIndex:n.getFieldsIndex(),timeZone:n.dateFieldsTimeZoneDefaultUTC}),d=pe(o)===!0?E(r):"%%%%FIELDNAME";s.push({name:d,expression:o}),d==="%%%%FIELDNAME"&&(p=!0)}else{if(!(r instanceof C))throw new c(t,m.InvalidParameter,a);{const o=r.hasField("name")?r.field("name"):"%%%%FIELDNAME",d=r.hasField("expression")?r.field("expression"):"";if(o==="%%%%FIELDNAME"&&(p=!0),!o)throw new c(t,m.InvalidParameter,a);s.push({name:o,expression:x.create(d||o,{fieldsIndex:n.getFieldsIndex(),timeZone:n.dateFieldsTimeZoneDefaultUTC})})}}if(l=[],v(e[2]))l.push(e[2]);else if(N(e[2]))l=e[2];else if($(e[2]))l=e[2].toArray();else{if(!(e[2]instanceof C))throw new c(t,m.InvalidParameter,a);l.push(e[2])}for(const r of l){if(!(r instanceof C))throw new c(t,m.InvalidParameter,a);{const o=r.hasField("name")?r.field("name"):"",d=r.hasField("statistic")?r.field("statistic"):"",w=r.hasField("expression")?r.field("expression"):"";if(!o||!d||!w)throw new c(t,m.InvalidParameter,a);f.push({name:o,statistic:d.toLowerCase(),expression:x.create(w,{fieldsIndex:n.getFieldsIndex(),timeZone:n.dateFieldsTimeZoneDefaultUTC})})}}if(p){const r={};for(const d of n.fields)r[d.name.toLowerCase()]=1;for(const d of s)d.name!=="%%%%FIELDNAME"&&(r[d.name.toLowerCase()]=1);for(const d of f)d.name!=="%%%%FIELDNAME"&&(r[d.name.toLowerCase()]=1);let o=0;for(const d of s)if(d.name==="%%%%FIELDNAME"){for(;r["field_"+o.toString()]===1;)o++;r["field_"+o.toString()]=1,d.name="FIELD_"+o.toString()}}for(const r of s)await ie(r.expression,i,t);for(const r of f)await ie(r.expression,i,t);return e[0].groupby(s,f)})},i.signatures.push({name:"groupby",min:3,max:3}),i.functions.distinct=function(t,a){return i.standardFunctionAsync(t,a,async(y,F,e)=>{if(A(e[0])){b(e,2,2,t,a);const n=await e[0].load(),s=[];let f=[];if(v(e[1]))f.push(e[1]);else if(e[1]instanceof C)f.push(e[1]);else if(N(e[1]))f=e[1];else{if(!$(e[1]))throw new c(t,m.InvalidParameter,a);f=e[1].toArray()}let p=!1;for(const l of f)if(v(l)){const r=x.create(E(l),{fieldsIndex:n.getFieldsIndex(),timeZone:n.dateFieldsTimeZoneDefaultUTC}),o=pe(r)===!0?E(l):"%%%%FIELDNAME";s.push({name:o,expression:r}),o==="%%%%FIELDNAME"&&(p=!0)}else{if(!(l instanceof C))throw new c(t,m.InvalidParameter,a);{const r=l.hasField("name")?l.field("name"):"%%%%FIELDNAME",o=l.hasField("expression")?l.field("expression"):"";if(r==="%%%%FIELDNAME"&&(p=!0),!r)throw new c(t,m.InvalidParameter,a);s.push({name:r,expression:x.create(o||r,{fieldsIndex:n.getFieldsIndex(),timeZone:n.dateFieldsTimeZoneDefaultUTC})})}}if(p){const l={};for(const o of n.fields)l[o.name.toLowerCase()]=1;for(const o of s)o.name!=="%%%%FIELDNAME"&&(l[o.name.toLowerCase()]=1);let r=0;for(const o of s)if(o.name==="%%%%FIELDNAME"){for(;l["field_"+r.toString()]===1;)r++;l["field_"+r.toString()]=1,o.name="FIELD_"+r.toString()}}for(const l of s)await ie(l.expression,i,t);return e[0].groupby(s,[])}return We(e)})},i.functions.getfeaturesetinfo=function(t,a){return i.standardFunctionAsync(t,a,async(y,F,e)=>{if(b(e,1,1,t,a),!A(e[0]))return null;const n=await e[0].getFeatureSetInfo();return n?C.convertObjectToArcadeDictionary({layerId:n.layerId,layerName:n.layerName,itemId:n.itemId,serviceLayerUrl:n.serviceLayerUrl,webMapLayerId:n.webMapLayerId??null,webMapLayerTitle:n.webMapLayerTitle??null,className:null,objectClassId:null},de(t),!1,!1):null})},i.signatures.push({name:"getfeaturesetinfo",min:1,max:1}),i.functions.filterbysubtypecode=function(t,a){return i.standardFunctionAsync(t,a,async(y,F,e)=>{if(b(e,2,2,t,a),A(e[0])){const n=await e[0].load(),s=e[1];if(!Se(s))throw new c(t,m.InvalidParameter,a);if(n.subtypeField){const p=x.create(`${n.subtypeField}= ${e[1]}`,{fieldsIndex:n.getFieldsIndex(),timeZone:n.dateFieldsTimeZoneDefaultUTC});return new B({parentfeatureset:e[0],whereclause:p})}if(n.typeIdField===null||n.typeIdField==="")throw new c(t,m.FeatureSetDoesNotHaveSubtypes,a);const f=x.create(`${n.typeIdField}= ${e[1]}`,{fieldsIndex:n.getFieldsIndex(),timeZone:n.dateFieldsTimeZoneDefaultUTC});return new B({parentfeatureset:e[0],whereclause:f})}throw new c(t,m.InvalidParameter,a)})},i.signatures.push({name:"filterbysubtypecode",min:2,max:2}))}export{Dn as registerFunctions};
